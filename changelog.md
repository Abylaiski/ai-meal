# Changelog

Все заметные изменения в проекте MealAI.

## [2.1.0] – 2025-04-28
### Added
- Локальная генерация описания изображений с помощью `transformers` (`BlipProcessor` + `BlipForConditionalGeneration`) вместо удалённого API, что ускоряет работу и позволяет обходиться без HF_API_TOKEN для BLIP.
- Кеширование ответов Mistral в таблице `mistral_cache` для повторного использования ранее полученных результатов и снижения числа запросов.
- Загрузка моделей BLIP и инициализация HTTP-сессии и соединения с БД в функции `init_resources()` для оптимизации старта бота.
- Увеличено ограничение `max_tokens` в запросах к Mistral до 300 токенов.

### Changed
- Перемещён импорт и инициализация `processor` и `model` в `init_resources()` вместо верхнего уровня модуля.
- Функция `call_mistral()` сначала проверяет кеш, затем сохраняет новые ответы в `mistral_cache`.
- Обновлён промт в `get_recommendation()`: ограничение до 3 предложений, фокус на пользе и умеренности, без общих фраз и рецептов.
- Функция `simplify_description()` возвращает самое длинное значимое слово, если Mistral вернул некорректный ответ.
- Улучшена обработка ошибок при загрузке и обработке изображения (логирование исключений, корректное чтение байтов).
- Конфигурация Pydantic-Settings оставляет `HF_API_TOKEN` для совместимости, но он больше не используется для BLIP.

### Fixed
- Исправлена ошибка чтения байтов изображения: использование `img_buf.read()` вместо `await`.
- Логика FSM подтверждения названия теперь сохраняет новое название сразу в кеш и не спрашивает повторно.

---

> **Примечание:**
> Для дальнейшего улучшения можно добавить RedisStorage для FSM и таблицу `cis_dishes` для блюд СНГ.


## [2.0.0] – 2025-04-25
### Added
- Единая таблица `mapping` вместо двух (`dish_mapping` и `feedback`) для кеширования BLIP-описаний → названий блюд.
- Функция `normalize()` для нормализации ключей (lowercase, очистка от пунктуации).
- Локальная база `local_nutrition` для хранения стартовых продуктов (`orange`, `apple`) и добавления через `/add_product`.
- Хендлер `/add_product` и `/list_products` для управления `local_nutrition` из чата.
- Жёсткие русскоязычные промты к Mistral:
  - `get_dish_name()` – возвращает короткое название блюда/продукта.
  - `get_nutrition()` – строго форматирует нутриенты: `Калории: X ккал; Белки: Y г; …`.
  - `get_recommendation()` – краткая практическая рекомендация.
- Логика FSM:
  - Спрашиваем подтверждение названия **только один раз** при первом появлении нового описания (флаг `is_new`).
  - Пользовательская правка сразу сохраняется в `mapping`, не спрашиваем повторно.

### Changed
- Переход к единому долгоживущему подключению к БД (`aiosqlite.Connection`) и HTTP-сессии (`aiohttp.ClientSession`).
- Исключена зависимость от OpenFoodFacts API — вся нутриентная логика via Mistral или локальный кеш.
- Упрощена логика обработки фото:
  - Если BLIP не распознал изображение — выдаём сообщение об ошибке.
  - Если Mistral вернул некорректный ответ (англ., слишком длинный или пустой) — fallback к `simplify_description()`.
- Улучшено логирование неудачных попыток Mistral (два ретрая с паузой и предупреждения в логе).

### Fixed
- Убраны лишние открытие/закрытие соединений с БД в каждом запросе — теперь один `db` на всё время.
- Обработка Ctrl+C / исключений при завершении работы бота: корректное закрытие сессий и БД.
- Все тексты бота исключительно на русском, без эм-дешей (только `-`).

---

> **Примечание:**
> При дальнейшем расширении проекта можно добавить таблицу `cis_dishes` для блюд СНГ, а также переключиться на RedisStorage для FSM в продакшене.